<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Enrollment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Hardcoded configuration to avoid config.js loading issues
        const CONFIG = {
            BACKEND_URL: "https://e-learning-backend-hywc.onrender.com",
            API: {
                GET_SECURITY_CODE: "/api/get-security-code",
                VERIFY_SECURITY_CODE: "/api/verify-security-code"
            },
            STORAGE: {
                IS_LOGGED_IN: "isLoggedIn",
                ENROLLED_EMAIL: "enrolledEmail"
            }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .enrollment-container {
            width: 100%;
            max-width: 440px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .content {
            padding: 24px;
        }

        .input-field {
            transition: all 0.3s ease;
        }

        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        .btn-primary {
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(90deg, #4338ca 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #10b981;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        [contenteditable]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            pointer-events: none;
        }

        [contenteditable]:focus:before {
            content: none;
        }

        [contenteditable] {
            white-space: nowrap;
            overflow: hidden;
        }

        [contenteditable] br {
            display: none;
        }

        [contenteditable] * {
            display: inline;
        }

        .btn-back {
            background: #f3f4f6;
            color: #4b5563;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .security-code {
            letter-spacing: 8px;
            font-size: 24px;
            text-align: center;
            font-weight: 600;
        }

        .step-transition {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .hidden-step {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }

        .visible-step {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
            position: relative;
        }

        .success-checkmark {
            color: #10b981;
            font-size: 48px;
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
        }
    </style>
</head>

<body>
    <div class="enrollment-container">
        <div class="header">
            <h1 class="text-2xl font-bold">Welcome to The Course</h1>
            <p class="mt-2 opacity-90">Enroll now to start your learning journey</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>

            <div id="main-container">
                <div id="email-section" class="visible-step">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <div id="email-input" contenteditable="true"
                            class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none min-h-[48px]"
                            data-placeholder="Enter your email address"></div>
                        <p id="email-error" class="mt-1 text-sm text-red-600 hidden">Please enter a valid email address</p>
                    </div>
                    <div class="flex justify-center">
                        <div id="get-code-button"
                            class="btn-primary w-full py-3 px-4 rounded-lg shadow-sm text-white font-semibold flex items-center justify-center cursor-pointer">
                            Get Security Code
                        </div>
                    </div>
                </div>

                <div id="code-section" class="hidden-step">
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Enter Security Code</h2>
                        <p class="mt-2 text-gray-600">We've sent a 6-digit code to your email</p>
                        <p id="email-display" class="mt-1 text-sm font-medium text-indigo-600"></p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Security Code</label>
                        <div id="security-code-input" contenteditable="true"
                            class="security-code input-field w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none min-h-[48px] text-center text-2xl font-mono"
                            data-placeholder="000000"></div>
                        <p id="code-error" class="mt-1 text-sm text-red-600 hidden">Please enter a valid 6-digit code</p>
                    </div>
                    <div class="flex space-x-4">
                        <div id="back-to-email-button"
                            class="btn-back flex-1 py-3 px-4 rounded-lg shadow-sm font-semibold cursor-pointer text-center">
                            Back
                        </div>
                        <div id="submit-code-button"
                            class="btn-secondary flex-1 py-3 px-4 rounded-lg shadow-sm text-white font-semibold flex items-center justify-center cursor-pointer">
                            Verify & Enroll
                        </div>
                    </div>
                </div>
            </div>

            <div id="success-step" class="step-transition hidden-step text-center py-8">
                <div class="success-checkmark">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mt-4">Enrollment Successful!</h2>
                <p class="mt-2 text-gray-600">You're being redirected to the course content</p>
                <div class="mt-6">
                    <div class="loader mx-auto"></div>
                </div>
            </div>

            <div id="message-box" class="mt-6 text-center py-3 px-4 rounded-lg hidden"></div>
        </div>
    </div>

    <script>
        // Override ALL browser default behaviors
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Page loaded - Overriding browser behaviors');
            
            // Override form submission globally
            document.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('ðŸš« Form submission blocked');
                return false;
            });
            
            // Override all link clicks
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('ðŸš« Link click blocked');
                    return false;
                }
            });
            
            // Override page unload (but allow intentional redirects)
            window.addEventListener('beforeunload', function(e) {
                if (allowRedirect) {
                    console.log('âœ… Allowing intentional redirect');
                    return;
                }
                console.log('âš ï¸ Page unload detected - this should not happen!');
                e.preventDefault();
                e.returnValue = '';
                return '';
            });
            
            // Override all key events globally
            document.addEventListener('keydown', function(e) {
                // Block F5, Ctrl+R, etc.
                if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('ðŸš« Page refresh blocked');
                    return false;
                }
            });
            
            // Override context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            });
            
            // Override drag and drop
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            });
            
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            });
        });
        
        // Global variable for allowing redirects
        let allowRedirect = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Elements
            const mainContainer = document.getElementById('main-container');
            const successStep = document.getElementById('success-step');
            const emailSection = document.getElementById('email-section');
            const codeSection = document.getElementById('code-section');
            const emailInput = document.getElementById('email-input');
            const securityCodeInput = document.getElementById('security-code-input');
            const getCodeButton = document.getElementById('get-code-button');
            const submitCodeButton = document.getElementById('submit-code-button');
            const backToEmailButton = document.getElementById('back-to-email-button');
            const messageBox = document.getElementById('message-box');
            const emailDisplay = document.getElementById('email-display');
            const emailError = document.getElementById('email-error');
            const codeError = document.getElementById('code-error');
            const progressFill = document.getElementById('progress-fill');

            // State
            let currentStep = 1;
            const totalSteps = 3;
            let isEmailStep = true;

            // Helper functions for contenteditable
            function getContenteditableValue(element) {
                return element.textContent.trim();
            }

            function setContenteditableValue(element, value) {
                element.textContent = value;
            }

            function clearContenteditable(element) {
                element.textContent = '';
            }

            // Update progress bar
            function updateProgress() {
                progressFill.style.width = `${(currentStep / totalSteps) * 100}%`;
            }

            // Show message function
            function showMessage(text, isError = false) {
                messageBox.textContent = text;
                messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
                setTimeout(() => messageBox.classList.add('hidden'), 5000);
            }

            // Validate email
            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            // Transition between steps
            function goToStep(step) {
                console.log('ðŸ”„ Going to step:', step);
                if (step === 1) {
                    isEmailStep = true;
                    emailSection.classList.remove('hidden-step');
                    emailSection.classList.add('visible-step');
                    codeSection.classList.add('hidden-step');
                    codeSection.classList.remove('visible-step');
                    currentStep = 1;
                    emailInput.focus();
                } else if (step === 2) {
                    isEmailStep = false;
                    emailSection.classList.add('hidden-step');
                    emailSection.classList.remove('visible-step');
                    codeSection.classList.remove('hidden-step');
                    codeSection.classList.add('visible-step');
                    currentStep = 2;
                    securityCodeInput.focus();
                } else if (step === 3) {
                    console.log('ðŸŽ‰ Showing success step');
                    mainContainer.classList.add('hidden');
                    successStep.classList.remove('hidden-step');
                    successStep.classList.add('visible-step');
                    currentStep = 3;
                }
                updateProgress();
                console.log('âœ… Step transition completed, current step:', currentStep);
            }

            // Get security code
            async function handleGetCode(e) {
                e.preventDefault();
                e.stopPropagation();

                const email = getContenteditableValue(emailInput);
                if (!email || !validateEmail(email)) {
                    emailError.classList.remove('hidden');
                    emailInput.classList.add('shake');
                    setTimeout(() => emailInput.classList.remove('shake'), 500);
                    return;
                }

                emailError.classList.add('hidden');
                getCodeButton.innerHTML = '<div class="loader"></div> Sending...';
                getCodeButton.setAttribute('disabled', 'true');

                try {
                    const apiUrl = CONFIG.BACKEND_URL + CONFIG.API.GET_SECURITY_CODE;
                    const response = await fetch('https://e-learning-backend-hywc.onrender.com/api/get-security-code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    await response.json();
                    showMessage('Security code sent to your email!');
                    emailDisplay.textContent = email;
                    clearContenteditable(securityCodeInput);
                    goToStep(2);
                } catch (error) {
                    console.error('Error sending code:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        showMessage('CORS error: Please ensure your backend allows cross-origin requests.', true);
                    } else if (error.message.includes('HTTP error')) {
                        showMessage(`Server error (${error.message}). Please try again.`, true);
                    } else {
                        showMessage('Failed to connect to the server. Please check your network.', true);
                    }
                } finally {
                    getCodeButton.innerHTML = 'Get Security Code';
                    getCodeButton.removeAttribute('disabled');
                }
            }

            // Submit code
            async function handleSubmitCode(e) {
                e.preventDefault();
                e.stopPropagation();

                const email = getContenteditableValue(emailInput);
                const code = getContenteditableValue(securityCodeInput);

                console.log('ðŸ” Verifying code:', { email, code });

                if (!code || code.length !== 6 || isNaN(code)) {
                    codeError.classList.remove('hidden');
                    securityCodeInput.classList.add('shake');
                    setTimeout(() => securityCodeInput.classList.remove('shake'), 500);
                    return;
                }

                codeError.classList.add('hidden');
                submitCodeButton.innerHTML = '<div class="loader"></div> Verifying...';
                submitCodeButton.setAttribute('disabled', 'true');

                try {
                    const apiUrl = CONFIG.BACKEND_URL + CONFIG.API.VERIFY_SECURITY_CODE;
                    console.log('ðŸŒ Making API request to:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, code })
                    });

                    console.log('ðŸ“¡ API response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('âœ… API response:', result);
                    
                    showMessage('Code verified successfully!');
                    
                    // Store enrollment data
                    localStorage.setItem(CONFIG.STORAGE.IS_LOGGED_IN, 'true');
                    localStorage.setItem(CONFIG.STORAGE.ENROLLED_EMAIL, email);
                    console.log('ðŸ’¾ Stored enrollment data in localStorage');

                    goToStep(3);
                    console.log('ðŸŽ¯ Moved to step 3');
                    
                    // Redirect after 2 seconds
                    const urlParams = new URLSearchParams(window.location.search);
                    const courseId = urlParams.get('course');
                    console.log('ðŸ”— Course ID from URL:', courseId);
                    
                    setTimeout(() => {
                        const redirectUrl = courseId ? `contentspage.html?course=${courseId}` : 'Courses.html';
                        console.log('ðŸš€ Redirecting to:', redirectUrl);
                        
                        // Allow the redirect by setting the flag
                        allowRedirect = true;
                        
                        // Use window.location.replace for a clean redirect
                        window.location.replace(redirectUrl);
                    }, 2000);
                } catch (error) {
                    console.error('âŒ Error verifying code:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        showMessage('CORS error: Please ensure your backend allows cross-origin requests.', true);
                    } else if (error.message.includes('HTTP error')) {
                        showMessage(`Server error (${error.message}). Please try again.`, true);
                    } else {
                        showMessage('Failed to connect to the server. Please check your network.', true);
                    }
                } finally {
                    submitCodeButton.innerHTML = 'Verify & Enroll';
                    submitCodeButton.removeAttribute('disabled');
                }
            }

            // Event listeners with maximum prevention
            getCodeButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('ðŸ–±ï¸ Get code button clicked');
                handleGetCode(e).catch(console.error);
                return false;
            });
            
            submitCodeButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('ðŸ–±ï¸ Submit code button clicked');
                handleSubmitCode(e).catch(console.error);
                return false;
            });
            
            backToEmailButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('ðŸ–±ï¸ Back button clicked');
                goToStep(1);
                return false;
            });

            emailInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('âŒ¨ï¸ Enter pressed in email field');
                    handleGetCode(e).catch(console.error);
                    return false;
                }
            });

            securityCodeInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('âŒ¨ï¸ Enter pressed in code field');
                    handleSubmitCode(e).catch(console.error);
                    return false;
                }
            });

            securityCodeInput.addEventListener('input', (e) => {
                const text = e.target.textContent;
                const numbersOnly = text.replace(/\D/g, '').slice(0, 6);
                if (text !== numbersOnly) {
                    e.target.textContent = numbersOnly;
                }
                codeError.classList.add('hidden');
            });

            emailInput.addEventListener('input', () => {
                emailError.classList.add('hidden');
            });

            // Prevent default form-like behavior on contenteditable
            emailInput.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text').trim();
                setContenteditableValue(emailInput, text);
            });

            securityCodeInput.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text').trim();
                const numbersOnly = text.replace(/\D/g, '').slice(0, 6);
                setContenteditableValue(securityCodeInput, numbersOnly);
            });

            // Initialize
            updateProgress();
            emailInput.focus();
            
            console.log('âœ… All event listeners attached with maximum prevention');
        });
    </script>
</body>

</html>
